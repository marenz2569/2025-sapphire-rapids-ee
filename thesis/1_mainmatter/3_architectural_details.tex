\chapter{Architectural Details of ``Sapphire Rapids'' Processors}
The Sapphire Rapids family of server processors is the successor to the ``Ice Lake'' architecture.
Building up on the design of the Skylake~\cite{Schoene_2019_SKL} and Cascade Lake~\cite{Velten_2022_Rome_CLX} architectures, it is the first in Intels lineup of server processor to introduce a modular design containing four tiles in a 2x2 grid interconnected with EMIB structures.
The two variants of this processor are the 4th Generation Intel Xeon Scalable Processor and Xeon CPU Max Series with four additional HBM blocks~\cite{Intel_2021_Hotchips}.
Each tile contains up to 15 Golden Cove cores with a shared L3 cache connected by a mesh, an accelerator complex, two DDR5 memory busses, 20 PCIe Gen 5/CXL lanes and one UPI 2.0 link.
This structure enables the package to be used in a single memory domain or split into two or four sub-NUMA clusters~\cite{Intel_4th_gen_scalable}.
The accelerator complex can contain contains up to four different accelerators:
Data Streaming Accelerator (DSA) allows for memory move, fill and compare offloading.
QuickAssist Technology (QAT), allows for acceleration of cryptographic operations.
Dynamic Load Balancer (DLB), brings hardware acceleratored queues.
In-Memory Analytics Accelerator (IAA), allows for memory compression, encryption and filtering.~\cite{Yifan_2024_intel_accelerator_ecosystem,Yuan_2023_ISCA_tutorial,Intel_4th_gen_scalable}
Which accelerators are activated depend on the specific SKU, while Intel allows for the option to install licenses through an PCI express interface\footnote{\url{https://github.com/intel/intel-sdsi}}~\cite{Krenn_2025_Intel_on_demand}.
\figref{spr-overview} show a high level view of the processor.

\begin{figure}[]
    \centering
    \includegraphics[width=\columnwidth]{fig/spr-uma.png}
    \caption{\label{fig:spr-overview}Block diagram of the 4th Generation Intel Xeon Scalable Processor from~\cite{Intel_4th_gen_scalable}.
Two mirrored tiles are arranged in a 2x2 grid, which are interconnected with EMIB structures to continue the mesh across the die boundaries.~\cite{Intel_2022_ISSCC}}
\end{figure}

\section{Golden Cove Core Microarchitecture}

\begin{figure}[]
    \centering
    \includegraphics[width=\columnwidth]{fig/GoldenCoveCore.pdf}
    \caption{Block diagram of the Golden Cove Core.}
    \todoms{Measurements for the schedulers. How did the frontend change? Details of port 5 closing.}
\end{figure}

\section{Test System Details}
I performed all measurements on an Intel Xeon Platinum 8480+ dual socket server.
\tabref{test-system} shows details of the specific test system.
If not noted otherwise, all measurements on this processor are performed with hyperthreading and SNC-4 is activated.

\begin{table}[t]
	\centering
	\caption{\label{tab:test-system}Test system (hati) details}
	\begin{tabular}{rr}
		\toprule
		Processor	&	2x Intel Xeon Platinum 8480+ \\
		\rowcolor[HTML]{EFEFEF}Cores		&	2x 56 \\
		Available frequencies	&	\SI{800}{\MHz} -- \SI{3800}{\MHz} (\SI{2000}{\MHz} nominal) \\
		\rowcolor[HTML]{EFEFEF}L1-i and L1-d cache	&	112x (\SI{32}{\kibi\byte} + \SI{48}{\kibi\byte})\\
		L2 cache	&	112x \SI{2048}{\kibi\byte} \\
		\rowcolor[HTML]{EFEFEF}L3 cache	&	2x \SI{105}{\mebi\byte} (2d-mesh) \\
		Mainboard	&	Intel Corporation D50DNP1SB \\
		\rowcolor[HTML]{EFEFEF}Memory		&	16x Micron MTC20F2085S1RC48BA1  \\
		\rowcolor[HTML]{EFEFEF}&	\SI{4800}{\mega\hertz} \\
		Disk		&	Samsung MZQL27T6HBLA-00A07 \\
		\rowcolor[HTML]{EFEFEF}OS           &   Ubuntu 22.04 LTS \\
		Kernel          &   6.8.0-79-generic \\
		\bottomrule
		%\vspace{6mm}
	\end{tabular}
\end{table}

\todoms{Add citation for the papers that also do this, but somewhat differently.}
To find out which of the cores and caches are deactived I run the stream benchmark on each CPU, collect the Vertical Egress Events\footnote{\textbf{TxR\_VERT\_OCCUPANCY0} with AD - Agent 0 and AK - Agent 0: event=144,umask=0x03}, measuring the occupancy of the egress buffers in the mesh stop, and the Horizontal Egress Events\footnote{\textbf{TxR\_HORZ\_OCCUPANCY} with AD - Uncredited and AK: event=160,umask=0x03}, measuring the occupancy of the transgress buffers, for all cache boxes.
This measurement is performed using the default core frequency without the use of hyperthreading.
I use the vertical occupancy event to associate the cores to cache boxes.
The horizontal occupancy is used to find which cache boxes are in the same row.
I assume that at least one row contains all cores/caches and that the ids of the cache boxes are numbered sequentially.
This allows me to align the rows and columns to one another around a complete row.
As sub numa clustering is activated, the size of the rows and columns are bound to the size of a tile.
Fig... show the physical map of the processor core and cache slices positions on the test system.

\todoms{add the map of the two sockets aligned in the same way as the spr-overview figure.}